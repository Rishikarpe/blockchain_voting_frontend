<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoteChain - e-KYC Verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            margin-bottom: 20px;
        }

        .logo img {
            height: 50px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .vote-color {
            color: #0066cc;
        }

        .chain-color {
            color: #00cc99;
        }

        .subtitle {
            color: #666;
            margin-bottom: 40px;
        }

        .ekyc-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .steps-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .steps-indicator::before {
            content: "";
            position: absolute;
            top: 15px;
            left: 50px;
            right: 50px;
            height: 2px;
            background-color: #ddd;
            z-index: 1;
        }

        .step-item {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 120px;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #666;
        }

        .active .step-circle {
            background-color: #0066cc;
            color: white;
        }

        .completed .step-circle {
            background-color: #00cc99;
            color: white;
        }

        .step-label {
            font-size: 14px;
            color: #666;
        }

        .active .step-label {
            color: #0066cc;
            font-weight: bold;
        }

        .completed .step-label {
            color: #00cc99;
            font-weight: bold;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .radio-option input {
            margin-right: 8px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
        }

        .upload-section {
            margin-top: 30px;
        }

        .upload-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-container:hover {
            border-color: #0066cc;
            background-color: rgba(0, 102, 204, 0.05);
        }

        .upload-icon {
            font-size: 40px;
            color: #0066cc;
            margin-bottom: 15px;
        }

        .upload-text {
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 12px;
            color: #888;
        }

        .preview-container {
            display: none;
            margin-top: 20px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
        }

        .camera-container {
            margin-top: 20px;
            display: none;
        }

        #cameraFeed {
            width: 100%;
            max-height: 300px;
            background-color: #eee;
            border-radius: 4px;
        }

        .camera-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }

        button {
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-back {
            background-color: white;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-back:hover {
            background-color: #f5f5f5;
        }

        .btn-next {
            background-color: #0066cc;
            color: white;
        }

        .btn-next:hover {
            background-color: #0055aa;
        }

        .btn-capture {
            background-color: #00cc99;
            color: white;
        }

        .btn-capture:hover {
            background-color: #00b386;
        }

        .btn-retry {
            background-color: #ff6b6b;
            color: white;
        }

        .btn-retry:hover {
            background-color: #ff5252;
        }

        .verification-section {
            display: none;
        }

        .success-container {
            text-align: center;
            padding: 30px 0;
        }

        .success-icon {
            font-size: 60px;
            color: #00cc99;
            margin-bottom: 20px;
        }

        .success-message {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .success-details {
            color: #666;
            margin-bottom: 30px;
        }

        /* Form sections - only one visible at a time */
        #selectIdSection, #uploadIdSection, #blockchainSection, #verificationSection, #successSection {
            display: none;
        }

        #selectIdSection {
            display: block; /* Initially visible */
        }

        #fileInput {
            display: none;
        }
        
        /* Blockchain info display */
        .blockchain-info {
            background-color: #f5f9ff;
            border-radius: 4px;
            padding: 15px;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .blockchain-info h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }
        
        .blockchain-info code {
            font-family: monospace;
            background-color: #e8f0fe;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .verification-log {
            height: 120px;
            overflow-y: auto;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .log-time {
            color: #0066cc;
        }
        
        .log-success {
            color: #00cc99;
        }
        
        .log-error {
            color: #ff5252;
        }

        /* Wallet connection styles */
        .wallet-options {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .wallet-option {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            width: 220px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wallet-option:hover {
            border-color: #0066cc;
            box-shadow: 0 4px 10px rgba(0, 102, 204, 0.1);
        }

        .wallet-option.selected {
            border-color: #00cc99;
            background-color: rgba(0, 204, 153, 0.05);
        }

        .wallet-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background-color: #f5f5f5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wallet-icon img {
            width: 40px;
        }

        .wallet-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .wallet-description {
            font-size: 12px;
            color: #666;
        }

        .wallet-status {
            margin-top: 30px;
            padding: 15px;
            border-radius: 4px;
            background-color: #f5f9ff;
            display: none;
        }

        .wallet-address {
            font-family: monospace;
            word-break: break-all;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }

        .chain-selection {
            margin-top: 20px;
        }

        .chain-selection select {
            margin-top: 10px;
        }

        .metamask-fox {
            color: #E2761B;
            font-size: 36px;
            line-height: 1;
        }

        .fox-ears {
            position: relative;
            font-size: 18px;
            top: -5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <!-- Replace with your actual logo URL -->
                <h2><span class="vote-color">Vote</span><span class="chain-color">Chain</span></h2>
            </div>
            <h1><span class="vote-color">Vote</span><span class="chain-color">Chain</span> e-KYC Verification</h1>
            <p class="subtitle">Verify your identity to ensure secure voting on our platform</p>
        </header>

        <div class="ekyc-container">
            <div class="steps-indicator">
                <div class="step-item active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Select ID</div>
                </div>
                <div class="step-item" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Recognition</div>
                </div>
                <div class="step-item" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Connect wallet</div>
                </div>
                <div class="step-item" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Verification</div>
                </div>
                <div class="step-item" id="step5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Complete</div>
                </div>
            </div>

            <!-- Step 1: Select ID Type -->
            <div class="form-section" id="selectIdSection">
                <h3>Select Identity Document</h3>
                <p>Please select the type of document you want to use for verification:</p>
                
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="idType" value="voter" checked>
                        Voter ID
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="idType" value="aadhaar">
                        Aadhaar Card
                    </label>
                </div>

                <div class="form-group" id="voterIdFields">
                    <label for="voterId">Voter ID Number</label>
                    <input type="text" id="voterId" placeholder="Enter your Voter ID number" maxlength="10">
                    <small>For testing, use: ABC1234567 with DOB: 15/04/1985</small>
                </div>

                <div class="form-group" id="aadhaarFields" style="display: none;">
                    <label for="aadhaarId">Aadhaar Number</label>
                    <input type="number" id="aadhaarId" placeholder="Enter your 12-digit Aadhaar number" maxlength="12">
                    <small>For testing, use: 123456789012 with DOB: 10/12/1982</small>
                </div>

                <div class="form-group">
                    <label for="dob">Date of Birth</label>
                    <input type="text" id="dob" placeholder="DD/MM/YYYY">
                </div>

                <div class="button-container">
                    <div></div> <!-- Empty div to maintain flex spacing -->
                    <button class="btn-next" id="nextToUpload">Continue</button>
                </div>
            </div>

            <!-- Step 2: Upload Document -->
            <div class="form-section" id="uploadIdSection">
                <h3>Live detection</h3>
                <p>Please give permission to access camera.</p>

                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="uploadMethod" value="camera">
                        Use Camera
                    </label>
                </div>

                <div class="upload-section" id="uploadMethodFile">
                    <label for="fileInput" class="upload-container">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">Drag & drop your ID document here or click to browse</div>
                        <div class="upload-hint">Supported formats: JPEG, PNG, PDF (max 5MB)</div>
                    </label>

                    <input type="file" id="fileInput" accept="image/jpeg,image/png,application/pdf">
                    
                    <div class="preview-container" id="previewContainer">
                        <h4>Document Preview:</h4>
                        <img src="" alt="Document Preview" class="preview-image" id="previewImage">
                    </div>
                </div>

                <div class="camera-container" id="uploadMethodCamera">
                    <video id="cameraFeed" autoplay></video>
                    <div class="camera-buttons">
                        <button class="btn-capture" id="captureButton">Capture Photo</button>
                        <button class="btn-retry" id="retryButton" style="display: none;">Retry</button>
                    </div>
                    <canvas id="captureCanvas" style="display: none;"></canvas>
                </div>

                <div class="button-container">
                    <button class="btn-back" id="backToSelect">Back</button>
                    <button class="btn-next" id="nextToBlockchain">Continue</button>
                </div>
            </div>

            <!-- Step 3: Connect Blockchain Wallet -->
            <div class="form-section" id="blockchainSection">
                <h3>Connect Blockchain Wallet</h3>
                <p>Please connect your cryptocurrency wallet to verify your identity on the blockchain.</p>

                <div class="wallet-options">
                    <div class="wallet-option" id="metamaskOption">
                        <div class="wallet-icon">
                            <div class="metamask-fox">
                                <span class="fox-ears">^.^</span>
                                <span>🦊</span>
                            </div>
                        </div>
                        <div class="wallet-name">MetaMask</div>
                        <div class="wallet-description">Connect to your MetaMask wallet</div>
                    </div>
                    
                    <div class="wallet-option" id="coinbaseOption">
                        <div class="wallet-icon">
                            <div style="color: #0052FF; font-weight: bold; font-size: 24px;">CB</div>
                        </div>
                        <div class="wallet-name">Coinbase Wallet</div>
                        <div class="wallet-description">Connect to your Coinbase wallet</div>
                    </div>
                    
                    <div class="wallet-option" id="walletConnectOption">
                        <div class="wallet-icon">
                            <div style="color: #3B99FC; font-weight: bold; font-size: 24px;">WC</div>
                        </div>
                        <div class="wallet-name">WalletConnect</div>
                        <div class="wallet-description">Connect using WalletConnect</div>
                    </div>
                </div>

                <div class="wallet-status" id="walletStatus">
                    <div>
                        <span id="connectionStatus">Connecting to wallet...</span>
                    </div>
                    <div class="wallet-address" id="walletAddress">
                        0x0000000000000000000000000000000000000000
                    </div>
                    
                    <div class="chain-selection">
                        <label for="blockchainNetwork">Select Network:</label>
                        <select id="blockchainNetwork">
                            <option value="ethereum">Ethereum Mainnet</option>
                            <option value="polygon" selected>Polygon PoS</option>
                            <option value="bsc">BNB Smart Chain</option>
                            <option value="arbitrum">Arbitrum One</option>
                        </select>
                    </div>
                </div>

                <div class="button-container">
                    <button class="btn-back" id="backToUpload2">Back</button>
                    <button class="btn-next" id="nextToVerify" disabled>Continue</button>
                </div>
            </div>

            <!-- Step 4: Verification -->
            <div class="form-section" id="verificationSection">
                <h3>Document Verification</h3>
                <p>We are verifying your document. Please wait...</p>

                <div class="verification-progress">
                    <div id="progressBar" style="width: 100%; height: 8px; background-color: #eee; border-radius: 4px; margin: 30px 0;">
                        <div id="progressFill" style="width: 0%; height: 100%; background-color: #0066cc; border-radius: 4px; transition: width 1.5s ease;"></div>
                    </div>
                    <p id="verificationStatus">Initializing verification...</p>
                </div>

                <div class="verification-log" id="verificationLog">
                    <!-- Verification logs will be displayed here -->
                </div>

                <div class="button-container">
                    <button class="btn-back" id="backToBlockchain">Back</button>
                    <button class="btn-next" id="completeVerification" disabled>Continue</button>
                </div>
            </div>

            <!-- Step 5: Success -->
            <div class="form-section" id="successSection">
                <div class="success-container">
                    <div class="success-icon">✅</div>
                    <h3 class="success-message">Verification Successful</h3>
                    <p class="success-details">Your identity has been successfully verified. You can now proceed with the voting process.</p>
                    
                    <div class="blockchain-info" id="blockchainInfo">
                        <h4>Blockchain Verification Record</h4>
                        <p>Transaction ID: <code id="transactionId">...</code></p>
                        <p>Timestamp: <code id="timestamp">...</code></p>
                        <p>Block Number: <code id="blockNumber">...</code></p>
                        <p>Wallet Address: <code id="verifiedWalletAddress">...</code></p>
                        <p>Network: <code id="verifiedNetwork">...</code></p>
                    </div>
                    
                    <button class="btn-next" id="finishButton">Continue to Voting</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
    // *** MOCK DATABASE AND VERIFICATION FUNCTIONS ***
    
    // Mock database of UIDs for testing
    const mockUserDatabase = {
        // Voter IDs
        "ABC1234567": { name: "John Doe", dob: "15/04/1985", faceHash: "face_hash_1" },
        "XYZ9876543": { name: "Jane Smith", dob: "22/09/1990", faceHash: "face_hash_2" },
        
        // Aadhaar numbers
        "123456789012": { name: "Amit Kumar", dob: "10/12/1982", faceHash: "face_hash_3" },
        "987654321098": { name: "Priya Sharma", dob: "05/06/1995", faceHash: "face_hash_4" }
    };
    
    // Mock UID verification function
    function verifyUID(idType, idNumber, dob) {
        return new Promise((resolve, reject) => {
            // Simulate network delay
            setTimeout(() => {
                if (idType === 'voter') {
                    if (mockUserDatabase[idNumber] && mockUserDatabase[idNumber].dob === dob) {
                        resolve({
                            verified: true,
                            userData: mockUserDatabase[idNumber]
                        });
                    } else {
                        resolve({
                            verified: false,
                            error: "Invalid Voter ID or date of birth"
                        });
                    }
                } else if (idType === 'aadhaar') {
                    if (mockUserDatabase[idNumber] && mockUserDatabase[idNumber].dob === dob) {
                        resolve({
                            verified: true,
                            userData: mockUserDatabase[idNumber]
                        });
                    } else {
                        resolve({
                            verified: false,
                            error: "Invalid Aadhaar number or date of birth"
                        });
                    }
                }
            }, 1500); // Simulate 1.5s delay
        });
    }
    
    // Mock face recognition function
    function performFaceRecognition(capturedImageData, storedFaceHash) {
        return new Promise((resolve, reject) => {
            // Simulate processing delay
            setTimeout(() => {
                // Random success rate of 80% for testing
                const isMatch = Math.random() < 0.8;
                
                if (isMatch) {
                    resolve({
                        success: true,
                        confidence: (Math.random() * 20 + 80).toFixed(2) // Random confidence between 80-100%
                    });
                } else {
                    resolve({
                        success: false,
                        confidence: (Math.random() * 30 + 50).toFixed(2), // Random confidence between 50-80%
                        error: "Face verification failed. Please try again."
                    });
                }
            }, 2000); // Simulate 2s delay
        });
    }
    
    // Custom UID generation function
    function generateUID(idType) {
        if (idType === 'voter') {
            // Generate a random 10-character Voter ID
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            
            // First 3 characters are letters
            for (let i = 0; i < 3; i++) {
                result += characters.charAt(Math.floor(Math.random() * 26));
            }
            
            // Next 7 characters are numbers
            for (let i = 0; i < 7; i++) {
                result += characters.charAt(Math.floor(Math.random() * 10) + 26);
            }
            
            return result;
        } else if (idType === 'aadhaar') {
            // Generate a random 12-digit Aadhaar number
            let result = '';
            for (let i = 0; i < 12; i++) {
                result += Math.floor(Math.random() * 10);
            }
            return result;
        }
        
        return null;
    }
    
    // *** BLOCKCHAIN IMPLEMENTATION ***
    
    // Simplified blockchain class for e-KYC verification records
    class VoteChainBlock {
        constructor(index, timestamp, data, previousHash = '') {
            this.index = index;
            this.timestamp = timestamp;
            this.data = data;
            this.previousHash = previousHash;
            this.hash = this.calculateHash();
            this.nonce = 0;
        }

        calculateHash() {
            // In a real implementation, you would use a proper hashing library
            return btoa(JSON.stringify(this) + this.nonce);
        }

        mineBlock(difficulty) {
            // Simple proof of work
            while (this.hash.substring(0, difficulty) !== Array(difficulty + 1).join("0")) {
                this.nonce++;
                this.hash = this.calculateHash();
            }
            
            // Log mining success
            logVerificationStep("Block mined: " + this.hash.substring(0, 16) + "...");
        }
    }

    class VoteChain {
        constructor() {
            this.chain = [this.createGenesisBlock()];
            this.difficulty = 2;
            this.pendingTransactions = [];
        }

        createGenesisBlock() {
            return new VoteChainBlock(0, Date.now(), "Genesis Block", "0");
        }

        getLatestBlock() {
            return this.chain[this.chain.length - 1];
        }

        addVerificationRecord(userId, verificationData) {
            const timestamp = Date.now();
            const transactionId = this.generateTransactionId(userId, timestamp);
            
            const newBlock = new VoteChainBlock(
                this.chain.length,
                timestamp,
                {
                    userId: userId,
                    transactionId: transactionId,
                    verificationData: verificationData,
                    action: "e-KYC Verification"
                },
                this.getLatestBlock().hash
            );
            
            newBlock.mineBlock(this.difficulty);
            this.chain.push(newBlock);
            
            return newBlock;
        }

        generateTransactionId(userId, timestamp) {
            // Simple transaction ID generator
            return "txn_" + btoa(userId + timestamp).substring(0, 16);
        }

        isChainValid() {
            for (let i = 1; i < this.chain.length; i++) {
                const currentBlock = this.chain[i];
                const previousBlock = this.chain[i - 1];

                if (currentBlock.hash !== currentBlock.calculateHash()) {
                    return false;
                }

                if (currentBlock.previousHash !== previousBlock.hash) {
                    return false;
                }
            }
            return true;
        }
    }

    // Initialize blockchain
    const voteChain = new VoteChain();
    
    // *** UI ELEMENTS AND EVENT HANDLERS ***
    
    // Elements
    const selectIdSection = document.getElementById('selectIdSection');
    const uploadIdSection = document.getElementById('uploadIdSection');
    const blockchainSection = document.getElementById('blockchainSection');
    const verificationSection = document.getElementById('verificationSection');
    const successSection = document.getElementById('successSection');

    const voterIdFields = document.getElementById('voterIdFields');
    const aadhaarFields = document.getElementById('aadhaarFields');
    
    const uploadMethodFile = document.getElementById('uploadMethodFile');
    const uploadMethodCamera = document.getElementById('uploadMethodCamera');
    
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    
    const cameraFeed = document.getElementById('cameraFeed');
    const captureButton = document.getElementById('captureButton');
    const retryButton = document.getElementById('retryButton');
    const captureCanvas = document.getElementById('captureCanvas');
    
    const progressFill = document.getElementById('progressFill');
    const verificationStatus = document.getElementById('verificationStatus');
    const verificationLog = document.getElementById('verificationLog');
    
    // Blockchain info elements
    const transactionIdElement = document.getElementById('transactionId');
    const timestampElement = document.getElementById('timestamp');
    const blockNumberElement = document.getElementById('blockNumber');
    const verifiedWalletAddressElement = document.getElementById('verifiedWalletAddress');
    const blockHashElement = document.getElementById('blockHash');
    
    // Form elements
    const idTypeSelect = document.getElementById('idType');
    const voterId = document.getElementById('voterId');
    const voterDob = document.getElementById('voterDob');
    const aadhaarNumber = document.getElementById('aadhaarNumber');
    const aadhaarDob = document.getElementById('aadhaarDob');
    const submitIdButton = document.getElementById('submitId');
    const submitVerificationButton = document.getElementById('submitVerification');
    
    // User data and session variables
    let currentUser = null;
    let capturedImage = null;
    let currentIdType = null;
    let currentIdNumber = null;
    let currentDob = null;
    let mediaStream = null;
    let verificationComplete = false;
    
    // Wallet address simulation for blockchain verification
    const walletAddress = "0x" + Array(40).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('');
    
    // *** HELPER FUNCTIONS ***
    
    // Function to update progress bar
    function updateProgress(percent) {
        progressFill.style.width = percent + '%';
    }
    
    // Function to log verification steps
    function logVerificationStep(message) {
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        
        const timestamp = new Date().toLocaleTimeString();
        logItem.innerHTML = `<span class="log-time">${timestamp}</span> ${message}`;
        
        verificationLog.appendChild(logItem);
        verificationLog.scrollTop = verificationLog.scrollHeight;
    }
    
    // Function to show a section and hide others
    function showSection(sectionToShow) {
        const allSections = [selectIdSection, uploadIdSection, verificationSection, blockchainSection, successSection];
        
        allSections.forEach(section => {
            if (section === sectionToShow) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        });
    }
    
    // Function to handle ID type selection
    function handleIdTypeChange() {
        const selectedIdType = idTypeSelect.value;
        
        if (selectedIdType === 'voter') {
            voterIdFields.style.display = 'block';
            aadhaarFields.style.display = 'none';
        } else if (selectedIdType === 'aadhaar') {
            voterIdFields.style.display = 'none';
            aadhaarFields.style.display = 'block';
        }
    }
    
    // Function to start camera
    async function startCamera() {
        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
            cameraFeed.srcObject = mediaStream;
            cameraFeed.style.display = 'block';
            captureButton.style.display = 'block';
            retryButton.style.display = 'none';
            captureCanvas.style.display = 'none';
        } catch (error) {
            console.error("Error accessing camera:", error);
            alert("Could not access camera. Please check your permissions or try using file upload.");
        }
    }
    
    // Function to stop camera
    function stopCamera() {
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
            cameraFeed.srcObject = null;
        }
    }
    
    // Function to capture image from camera
    function captureImage() {
        const context = captureCanvas.getContext('2d');
        captureCanvas.width = cameraFeed.videoWidth;
        captureCanvas.height = cameraFeed.videoHeight;
        
        context.drawImage(cameraFeed, 0, 0, captureCanvas.width, captureCanvas.height);
        
        // Convert canvas to data URL
        capturedImage = captureCanvas.toDataURL('image/png');
        
        // Display captured image
        cameraFeed.style.display = 'none';
        captureButton.style.display = 'none';
        captureCanvas.style.display = 'block';
        retryButton.style.display = 'block';
        
        // Enable the submit button
        submitVerificationButton.disabled = false;
    }
    
    // Function to handle file upload
    function handleFileUpload(event) {
        const file = event.target.files[0];
        
        if (file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                capturedImage = e.target.result;
                previewImage.src = capturedImage;
                previewContainer.style.display = 'block';
                
                // Enable the submit button
                submitVerificationButton.disabled = false;
            };
            
            reader.readAsDataURL(file);
        }
    }
    
    // Function to perform ID verification
    async function verifyIdentity() {
        try {
            showSection(verificationSection);
            updateProgress(0);
            verificationStatus.textContent = "Starting verification...";
            logVerificationStep("Verification process initiated");
            
            // Step 1: Verify ID information
            updateProgress(20);
            verificationStatus.textContent = "Verifying ID information...";
            logVerificationStep("Verifying ID details with government database");
            
            const verificationResult = await verifyUID(currentIdType, currentIdNumber, currentDob);
            
            if (!verificationResult.verified) {
                throw new Error(verificationResult.error);
            }
            
            currentUser = verificationResult.userData;
            logVerificationStep("ID verification successful: " + currentUser.name);
            
            // Step 2: Perform face recognition
            updateProgress(40);
            verificationStatus.textContent = "Performing facial recognition...";
            logVerificationStep("Starting biometric verification");
            
            const faceResult = await performFaceRecognition(capturedImage, currentUser.faceHash);
            
            if (!faceResult.success) {
                throw new Error(faceResult.error);
            }
            
            logVerificationStep(`Face verification successful (${faceResult.confidence}% match)`);
            
            // Step 3: Record verification on blockchain
            updateProgress(60);
            verificationStatus.textContent = "Recording verification on blockchain...";
            logVerificationStep("Initiating blockchain transaction");
            
            const verificationData = {
                name: currentUser.name,
                idType: currentIdType,
                idNumber: currentIdNumber.substring(0, 3) + "****" + currentIdNumber.substring(currentIdNumber.length - 3),
                verificationTime: new Date().toISOString(),
                faceMatchConfidence: faceResult.confidence
            };
            
            const block = voteChain.addVerificationRecord(currentIdNumber, verificationData);
            
            updateProgress(80);
            verificationStatus.textContent = "Finalizing verification...";
            
            // Step 4: Display blockchain receipt
            updateProgress(100);
            verificationStatus.textContent = "Verification complete!";
            logVerificationStep("e-KYC verification successfully completed");
            
            // Display blockchain receipt
            transactionIdElement.textContent = block.data.transactionId;
            timestampElement.textContent = new Date(block.timestamp).toLocaleString();
            blockNumberElement.textContent = block.index;
            verifiedWalletAddressElement.textContent = walletAddress;
            blockHashElement.textContent = block.hash.substring(0, 16) + "...";
            
            setTimeout(() => {
                showSection(blockchainSection);
            }, 2000);
            
            verificationComplete = true;
            
        } catch (error) {
            verificationStatus.textContent = "Verification failed: " + error.message;
            logVerificationStep("ERROR: " + error.message);
            updateProgress(100);
            
            // Allow retry after 3 seconds
            setTimeout(() => {
                showSection(selectIdSection);
            }, 3000);
        }
    }
    
    // *** EVENT LISTENERS ***
    
    // ID type selection change
    idTypeSelect.addEventListener('change', handleIdTypeChange);
    
    // ID submission form
    submitIdButton.addEventListener('click', function() {
        // Validate form data
        let isValid = false;
        
        if (idTypeSelect.value === 'voter') {
            currentIdType = 'voter';
            currentIdNumber = voterId.value.trim();
            currentDob = voterDob.value.trim();
            
            isValid = currentIdNumber && currentDob;
        } else if (idTypeSelect.value === 'aadhaar') {
            currentIdType = 'aadhaar';
            currentIdNumber = aadhaarNumber.value.trim();
            currentDob = aadhaarDob.value.trim();
            
            isValid = currentIdNumber && currentDob;
        }
        
        if (isValid) {
            showSection(uploadIdSection);
        } else {
            alert("Please fill all required fields.");
        }
    });
    
    // Upload method selection
    uploadMethodFile.addEventListener('change', function() {
        if (this.checked) {
            fileInput.style.display = 'block';
            previewContainer.style.display = 'none';
            
            // Hide camera elements
            cameraFeed.style.display = 'none';
            captureButton.style.display = 'none';
            captureCanvas.style.display = 'none';
            retryButton.style.display = 'none';
            
            // Stop camera if active
            stopCamera();
        }
    });
    
    uploadMethodCamera.addEventListener('change', function() {
        if (this.checked) {
            fileInput.style.display = 'none';
            previewContainer.style.display = 'none';
            
            // Start camera
            startCamera();
        }
    });
    
    // File upload
    fileInput.addEventListener('change', handleFileUpload);
    
    // Camera capture
    captureButton.addEventListener('click', captureImage);
    
    // Retry capture
    retryButton.addEventListener('click', function() {
        captureCanvas.style.display = 'none';
        retryButton.style.display = 'none';
        
        // Restart camera
        startCamera();
    });
    
    // Submit verification
    submitVerificationButton.addEventListener('click', verifyIdentity);
    
    // Return to home button
    document.getElementById('returnToHome').addEventListener('click', function() {
        // Reset form and start over
        idTypeSelect.selectedIndex = 0;
        voterId.value = '';
        voterDob.value = '';
        aadhaarNumber.value = '';
        aadhaarDob.value = '';
        fileInput.value = '';
        previewImage.src = '';
        capturedImage = null;
        currentUser = null;
        verificationComplete = false;
        
        // Stop camera if active
        stopCamera();
        
        // Show first section
        handleIdTypeChange();
        showSection(selectIdSection);
    });
    
    // Complete process button
    document.getElementById('completeProcess').addEventListener('click', function() {
        showSection(successSection);
    });
    
    // Download certificate button
    document.getElementById('downloadCertificate').addEventListener('click', function() {
        // Create a simple certificate with verification details
        const certificateHTML = `
            <html>
            <head>
                <title>e-KYC Verification Certificate</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; }
                    .certificate { border: 2px solid #1a73e8; padding: 20px; max-width: 600px; margin: 0 auto; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .title { font-size: 24px; color: #1a73e8; }
                    .content { margin-bottom: 20px; }
                    .footer { text-align: center; font-size: 12px; margin-top: 30px; }
                    .qr-placeholder { width: 150px; height: 150px; border: 1px solid #ccc; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
                </style>
            </head>
            <body>
                <div class="certificate">
                    <div class="header">
                        <h1 class="title">e-KYC Verification Certificate</h1>
                        <p>This certificate verifies successful completion of electronic Know Your Customer verification</p>
                    </div>
                    
                    <div class="content">
                        <p><strong>Name:</strong> ${currentUser?.name || 'Not Available'}</p>
                        <p><strong>ID Type:</strong> ${currentIdType === 'voter' ? 'Voter ID' : 'Aadhaar'}</p>
                        <p><strong>ID Number:</strong> ${currentIdNumber ? currentIdNumber.substring(0, 3) + "****" + currentIdNumber.substring(currentIdNumber.length - 3) : 'Not Available'}</p>
                        <p><strong>Verification Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Transaction ID:</strong> ${transactionIdElement.textContent}</p>
                        <p><strong>Block Number:</strong> ${blockNumberElement.textContent}</p>
                        <p><strong>Blockchain Hash:</strong> ${blockHashElement.textContent}</p>
                    </div>
                    
                    <div class="qr-placeholder">
                        [QR Code]
                    </div>
                    
                    <div class="footer">
                        <p>This is a computer-generated certificate and does not require a physical signature.</p>
                        <p>Verification can be confirmed on the blockchain with the transaction ID above.</p>
                    </div>
                </div>
            </body>
            </html>
        `;
        
        // Create a Blob and download it
        const blob = new Blob([certificateHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'e-KYC_Verification_Certificate.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    // Initialize the application
    function init() {
        handleIdTypeChange();
        showSection(selectIdSection);
        submitVerificationButton.disabled = true;
    }
    
    // Start the application
    init();
    });
    </script>
</body>
</html>